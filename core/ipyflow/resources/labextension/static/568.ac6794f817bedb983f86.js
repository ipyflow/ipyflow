"use strict";(self.webpackChunkjupyterlab_ipyflow=self.webpackChunkjupyterlab_ipyflow||[]).push([[568],{568:(e,t,n)=>{n.r(t),n.d(t,{default:()=>F});var l=n(740),o=n(926),d=n(142),s=n(761),i=n.n(s);const c="ipyflow",a="waiting-cell",r="ready-cell",u="ready-making-cell",m="ready-making-input-cell",f="linked-waiting",h="linked-ready-maker",v=new Set;let y=new Set,_=new Set,p={},C={},w=null,g=null,E={},x={},k={},L=null,b=null,S=!1,j=!1,O=null,V=new Set,A=new Set,D=new Set;const I=new Event("cleanup"),N={id:"jupyterlab-ipyflow",requires:[d.INotebookTracker,l.ICommandPalette],autoStart:!0,activate:(e,t,n)=>{e.commands.addCommand("alt-mode-execute",{label:"Alt Mode Execute",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>{if(!j&&"code"===t.activeCell.model.type){j=!0;const e=t.currentWidget.sessionContext;e.isReady&&"code"===t.activeCell.model.type&&e.session.kernel.requestExecute({code:"%flow toggle-reactivity-until-next-reset",silent:!0,store_history:!1}).done.then((()=>{o.CodeCell.execute(t.activeCell,e)}))}}}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Accel Shift Enter"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Ctrl Shift Enter"],selector:".jp-Notebook"}),n.addItem({command:"alt-mode-execute",category:"execution",args:{}}),t.widgetAdded.connect(((e,t)=>{const n=t.sessionContext;n.ready.then((()=>{R(t.content),w=t.content.activeCell,g=t.content.activeCell.model.id;let e=function(){};n.session.kernel.name===c&&(e=z(n,t.content)),n.kernelChanged.connect(((l,o)=>{R(t.content),e(),e=function(){},null!==o.newValue&&o.newValue.name===c&&(e=z(n,t.content))}));let l=!1;n.statusChanged.connect(((n,o)=>{"restarting"!==o&&"autorestarting"!==o||(l=!0),"idle"!==o&&"busy"!==o||!l||(l=!1,n.ready.then((()=>{R(t.content),e(),e=function(){},n.session.kernel.name===c&&(e=z(n,t.content))})))}))}))}))}},P=e=>{if(null==e)return null;const t=e.children.item(1);return null===t?null:t.firstElementChild},q=e=>{if(null==e)return null;const t=e.children.item(2);return null===t?null:t.firstElementChild},B=(e,t,n)=>{const l=()=>{e.removeEventListener(t,n),e.removeEventListener("cleanup",l)};e.addEventListener(t,n),e.addEventListener("cleanup",l)},K=(e,t,n,l,o)=>{null!==e&&null!==t&&B(e,n,(()=>{t.firstElementChild.classList[l](o)}))},M=(e,t)=>{K(P(e),q(e),"mouseover","add",f),K(P(e),q(e),"mouseout","remove",f),K(q(e),P(e),"mouseover","add",t),K(q(e),P(e),"mouseout","remove",t)},T=e=>{E={},x={},k={},e.widgets.forEach(((e,t)=>{E[e.model.id]=e.node,x[e.model.id]=e.model,k[e.model.id]=t}))},R=e=>{e.widgets.forEach(((e,t)=>{e.node.classList.remove(a),e.node.classList.remove(u),e.node.classList.remove(r),e.node.classList.remove(m);const n=P(e.node);null!==n&&(n.firstElementChild.classList.remove(f),n.firstElementChild.classList.remove(h),n.dispatchEvent(I));const l=q(e.node);null!==l&&(l.firstElementChild.classList.remove(f),l.firstElementChild.classList.remove(h),l.dispatchEvent(I))}))},W=(e,t,n,l,o,d,s)=>{if(null===e)return;const i=()=>{for(const e of t){let t=h;s.has(e)&&(t=f);const o=l(n[e]);if(null===o||null===o.firstElementChild)return;o.firstElementChild.classList[d](t)}};e.addEventListener(o,i),B(e,o,i)},z=(e,t)=>{const n=e.session.kernel.createComm("ipyflow");let l=!1;const d=()=>{const e={};return t.widgets.forEach(((t,n)=>{e[t.model.id]={index:n,content:t.model.value.text,type:t.model.type}})),e},s=i().debounce((()=>{l?t.model.contentChanged.disconnect(s):n.send({type:"notify_content_changed",cell_metadata_by_id:d()})}),500),c=e=>{const t=d();n.send({type:"compute_exec_schedule",executed_cell_id:null==e?void 0:e.id,cell_metadata_by_id:t})},k=(e,n)=>{l?e.stateChanged.disconnect(k):"executionCount"===n.name&&null!==n.newValue&&(t.widgets.forEach(((t,n)=>{t.model.id===e.id&&(t.node.classList.remove(r),t.node.classList.remove(m))})),c(e))},I=e=>{let l=-1;t.widgets.forEach(((t,n)=>{t.model.id===e.id&&(l=n)}));const o={type:"change_active_cell",active_cell_id:e.id,active_cell_order_idx:l};n.send(o)},N=(e,n)=>{if(t===e)if(l)t.activeCellChanged.disconnect(N);else if(I(n.model),null!==w&&null!==w.model&&(w.model.isDirty?v.add(g):v.delete(g),w.model.stateChanged.disconnect(k,w.model.stateChanged)),w=n,g=n.model.id,null!==w&&null!==w.model&&"code"===w.model.type){if(w.model.stateChanged.connect(k),I(w.model),v.has(g)){const e=w.model;void 0!==e._setDirty&&e._setDirty(!0)}T(t),K(g)}};t.activeCellChanged.connect(N);const B=[{action:"mouseover",update:"add"},{action:"mouseout",update:"remove"}],K=e=>{const t=x[e];if("code"!==t.type)return;if(null==t.executionCount)return;const n=E[e];y.has(e)?(n.classList.add(a),n.classList.add(r),n.classList.remove(m),M(n,f)):_.has(e)&&(n.classList.add(m),n.classList.add(r),M(n,h)),"reactive"!==b&&(Object.prototype.hasOwnProperty.call(p,e)&&B.forEach((({action:t,update:l})=>{W(P(n),p[e],E,P,t,l,y),W(q(n),p[e],E,P,t,l,y)})),Object.prototype.hasOwnProperty.call(C,e)&&(y.has(e)||(n.classList.add(u),n.classList.add(r)),B.forEach((({action:t,update:l})=>{W(P(n),C[e],E,P,t,l,y),W(P(n),C[e],E,q,t,l,y)}))))};return n.onMsg=d=>{var i;const a=d.content.data;if(!l&&null!==(i=a.success)&&void 0!==i&&i)if("establish"===a.type)t.activeCell.model.stateChanged.connect(k),I(t.activeCell.model),t.model.contentChanged.connect(s),c();else if("compute_exec_schedule"===a.type){y=new Set(a.waiting_cells),_=new Set(a.ready_cells),A=new Set([...A,...a.new_ready_cells]),D=new Set([...D,...a.forced_reactive_cells]),p=a.waiter_links,C=a.ready_maker_links,L=null;const l=a.exec_mode;S=S||"reactive"===l;const d=a.flow_order,s=a.exec_schedule;b=l,O=a.highlights;const i=a.last_executed_cell_id;if(V.add(i),!a.last_execution_was_error){let e=!1;for(const n of t.widgets){if(!e&&(e=n.model.id===i,"in_order"===d||"strict"===s))continue;if("code"!==n.model.type||V.has(n.model.id))continue;if(!A.has(n.model.id))continue;if(!D.has(n.model.id)&&"reactive"!==l)continue;const t=n;if(null===L){if(L=t,"in_order"===d||"strict"===s)break}else null==t.model.executionCount||t.model.executionCount<L.model.executionCount&&(L=t)}}null===L?(S&&("reactive"===O&&(_=V),n.send({type:"reactivity_cleanup"})),D=new Set,A=new Set,V=new Set,(e=>{if(R(e),"none"!==O){T(e);for(const[e]of Object.entries(E))K(e)}})(t),S=!1,j=!1):(S=!0,N(t,L),o.CodeCell.execute(L,e))}},n.open({}),()=>{l=!0}},F=N}}]);